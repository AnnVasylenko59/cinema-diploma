# Стратегія резервного копіювання та відновлення (Backup & Restore)

Цей документ визначає регламент збереження даних проєкту `cinema-diploma` у виробничому (production) середовищі для забезпечення безперервності бізнесу та захисту від втрати даних.

---

## 1. Стратегія резервного копіювання

### Типи резервних копій
Для оптимізації місця та надійності використовуються такі типи копій:
* **Повні (Full):** Створення повного дампу бази даних та повного архіву конфігурацій і файлів системи.
* **Інкрементальні (Incremental):** Збереження лише тих логів та користувацьких файлів, які змінилися з моменту останнього бекапу.
* **Диференціальні (Differential):** Проміжні копії бази даних, що фіксують зміни відносно останнього повного бекапу (для швидшого відновлення).

### Частота створення резервних копій
* **База даних (PostgreSQL):** Повний бекап — щодня о 03:00. Інкрементальний (WAL-архіви) — кожні 4 години.
* **Конфігурації та файли:** Повний бекап — щотижня (у неділю).
* **Логи системи:** Щодня о 23:59.

### Зберігання та ротація копій
Застосовується правило "3-2-1" (3 копії, 2 носії, 1 віддалений).
* **Локальне зберігання:** `/var/backups/cinema/` (зберігаються останні 7 днів).
* **Віддалене зберігання:** AWS S3 Bucket або Google Cloud Storage.
* **Ротація (Retention Policy):** * Щоденні копії зберігаються 7 днів.
    * Щотижневі копії зберігаються 4 тижні.
    * Щомісячні копії зберігаються 1 рік. Застарілі копії видаляються автоматично.

---

## 2. Процедура резервного копіювання

### Бази даних
Створення стисненого дампу PostgreSQL:
```bash
pg_dump -U cinema_user -h localhost -d cinema_prod -F c -f /var/backups/cinema/db_full_$(date +%Y%m%d).dump
```

### Файлів конфігурацій
Архівація критичних файлів налаштувань (змінні середовища `.env` та налаштування Nginx):
```bash
tar -czvf /var/backups/cinema/config_$(date +%Y%m%d).tar.gz /var/www/cinema/backend/.env /etc/nginx/sites-available/cinema
```

### Користувацьких даних
Резервне копіювання статичних файлів, завантажених користувачами (наприклад, аватари):
```bash
rsync -a /var/www/cinema/backend/uploads/ /var/backups/cinema/uploads_sync/
```

### Логів системи
Збереження логів Nginx та PM2:
```bash
tar -czvf /var/backups/cinema/logs_$(date +%Y%m%d).tar.gz /var/log/nginx/ /home/ubuntu/.pm2/logs/
```

---

## 3. Перевірка цілісності резервних копій

Щотижня автоматизований скрипт перевіряє цілісність створених архівів:
1. **Перевірка файлів:** Використання `md5sum` для перевірки хешів архівів після передачі на хмарне сховище.
2. **Перевірка БД:** Пробна спроба читання заголовків дампу без його розгортання:
   ```bash
   pg_restore -l /var/backups/cinema/db_full_20240101.dump > /dev/null
   ```

---

## 4. Автоматизація процесу

Усі вищевказані кроки об'єднані у bash-скрипт (`docs/scripts/backup.sh`), який виконується автоматично через системний планувальник **cron**.

Налаштування crontab (`crontab -e`):
```bash
# Запуск бекапу щодня о 03:00 ночі
0 3 * * * /var/www/cinema/docs/scripts/backup.sh >> /var/log/cinema_backup.log 2>&1
```

---

## 5. Процедура відновлення з резервних копій (Disaster Recovery)

### Повне відновлення системи (Full Recovery)
Застосовується у разі критичного збою сервера:
1. Зупинити застосунок: `pm2 stop cinema-api`
2. Відновити конфігурації `.env` та налаштування Nginx з архіву `config_*.tar.gz`.
3. Видалити пошкоджену БД та створити нову:
   ```bash
   sudo -u postgres psql -c "DROP DATABASE cinema_prod;"
   sudo -u postgres psql -c "CREATE DATABASE cinema_prod WITH OWNER cinema_user;"
   ```
4. Відновити БД з дампу:
   ```bash
   pg_restore -U cinema_user -d cinema_prod -1 /var/backups/cinema/db_full_*.dump
   ```
5. Перезапустити служби: `pm2 start cinema-api` та `sudo systemctl restart nginx`.

### Вибіркове відновлення даних (Partial Recovery)
Застосовується, якщо випадково видалено конкретну таблицю або файл:
* **Файли:** Ручне розпакування потрібного файлу з `tar`-архіву.
* **БД:** Відновлення конкретної таблиці з повного дампу:
  ```bash
  pg_restore -U cinema_user -d cinema_prod -t "User" /var/backups/cinema/db_full_*.dump
  ```

### Тестування відновлення (Recovery Drill)
* **Частота:** 1 раз на квартал.
* **Процес:** DevOps-інженер розгортає бекап на ізольованому тестовому (Staging) сервері, щоб переконатися, що дані консистентні і система успішно запускається. Після перевірки тестове середовище знищується.